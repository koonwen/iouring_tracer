(executable
 (public_name trace_uring)
 (name trace_uring)
 (libraries util definitions fxt)
 (modules trace_uring ring_writer))

(library
 (name util)
 (libraries ocaml_libbpf definitions fxt eio_linux)
 (modules util))

(rule
 (mode
  (promote (until-clean)))
 (deps
  (source_tree %{project_root}/bpf))
 (targets
  uring.bpf.o
  uring.h)
 (action
  (no-infer
   (progn
    (chdir
      %{project_root}/bpf
     (run make))
    (copy %{project_root}/bpf/output/uring.bpf.o uring.bpf.o)
    (copy# %{project_root}/bpf/uring.h uring.h)))))

; (rule
;  (alias bpf)
;  (target trace_uring.bpf.o)
;  (deps trace_uring.bpf.c definitions/defs.h vmlinux.h)
;  (action
;   (run
;    clang
;    -g
;    -O2
;    -target
;    bpf
;    -I
;    definitions
;    -c
;    trace_uring.bpf.c
;    -o
;    %{target})))
