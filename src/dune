(library
 (name util)
 (libraries ocaml_libbpf definitions fxt eio_linux)
 (modules util))

(executable
 (name trace)
 (libraries
  ocaml_libbpf
  unix
  fxt
  eio
  eio_linux
  ctypes
  ctypes-foreign
  definitions)
 (modules trace))

(executable
 (name uring_spans)
 (libraries util definitions fxt)
 (modules uring_spans))

(executable
 (name uring_ops)
 (libraries util definitions fxt)
 (modules uring_ops))

(data_only_dirs bpf_uring_events)

(rule
 (mode
  (promote (until-clean)))
 (deps
  (source_tree bpf_uring_events))
 (targets
  trace_uring.bpf.o
  defs.h
  uring_spans.bpf.o
  uring_spans.h
  uring_ops.bpf.o
  uring_ops.h)
 (action
  (no-infer
   (progn
    (chdir
     bpf_uring_events
     (run make))
    ; (copy_files bpf_uring_events/output/*)
    (copy bpf_uring_events/output/trace_uring.bpf.o trace_uring.bpf.o)
    (copy# bpf_uring_events/defs.h defs.h)
    (copy bpf_uring_events/output/uring_spans.bpf.o uring_spans.bpf.o)
    (copy# bpf_uring_events/uring_spans.h uring_spans.h)
    (copy bpf_uring_events/output/uring_ops.bpf.o uring_ops.bpf.o)
    (copy# bpf_uring_events/uring_ops.h uring_ops.h)))))

; (rule
;  (alias bpf)
;  (target trace_uring.bpf.o)
;  (deps trace_uring.bpf.c definitions/defs.h vmlinux.h)
;  (action
;   (run
;    clang
;    -g
;    -O2
;    -target
;    bpf
;    -I
;    definitions
;    -c
;    trace_uring.bpf.c
;    -o
;    %{target})))
